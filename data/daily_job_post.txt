<?php

// generate_whatsapp_message.php

// --- Configuration ---
// Set the default timezone to Indian Time (IST) for accurate date filtering
date_default_timezone_set('Asia/Kolkata');

// Path to your jobs data file
// Adjust the path relative to where this script is located if necessary
$jobsFilename = __DIR__ . '/jobs.json';

// Your website URL to be included in the message
$siteUrl = 'http://localhost:8000/index.php'; // <--- REPLACE with your website URL

// --- Main Script Logic ---

// Load job data
$decodedJobs = [];
if (file_exists($jobsFilename)) {
    $jsonData = file_get_contents($jobsFilename);
    $decodedJobs = json_decode($jsonData, true);
    if ($decodedJobs === null) {
        $decodedJobs = []; // Handle malformed JSON
        // Log the error for debugging if run via cron
        error_log("Error decoding jobs.json: " . json_last_error_msg());
    }
} else {
     // Log the error if run via cron
     error_log("Job data file not found: " . $jobsFilename);
     echo "Error: Job data file not found.\n"; // Output error if run manually
     exit; // Cannot proceed without data
}

// Filter jobs posted in the last 24 hours
$jobsToday = [];
// Calculate the Unix timestamp 24 hours ago
$cutoffTime = time() - (24 * 60 * 60);

foreach ($decodedJobs as $job) {
    // Use the 'posted_on_unix_ts' added by the front-end script if available and valid
    if (isset($job['posted_on_unix_ts']) && is_numeric($job['posted_on_unix_ts']) && $job['posted_on_unix_ts'] > 0) {
        $jobTimestamp = $job['posted_on_unix_ts'];
    } elseif (isset($job['posted_on']) && is_string($job['posted_on'])) {
         // Fallback: Try parsing the date string if the timestamp is missing or 0
         $jobTimestamp = strtotime($job['posted_on']);
         if ($jobTimestamp === false) {
             $jobTimestamp = 0; // Failed to parse
             error_log("Could not parse date string for job: " . ($job['title'] ?? 'Unknown') . " - " . $job['posted_on']);
         }
    } else {
         $jobTimestamp = 0; // No date info available
         error_log("Job missing 'posted_on' or 'posted_on_unix_ts': " . ($job['title'] ?? 'Unknown'));
    }

    // Include job if it has a valid timestamp and is within the last 24 hours
    if ($jobTimestamp > 0 && $jobTimestamp >= $cutoffTime) {
        $jobsToday[] = $job;
    }
}

$countToday = count($jobsToday);

// --- Format the message ---
$message = "🎯 Daily UAE Job Update\n\n"; // No bolding needed for plain text copy-paste

if ($countToday === 0) {
    $message .= "No new jobs were posted in the last 24 hours.\n";
} else {
    $message .= "Total jobs posted in the last 24 hours: " . $countToday . "\n\n";

    // Sort jobs by posted_on descending (newest first) - helps list newer jobs higher
    // Using the fallback parsing in case unix_ts is missing in the file
    usort($jobsToday, function($a, $b) {
        $ts_a = $a['posted_on_unix_ts'] ?? (strtotime($a['posted_on'] ?? '') ?: 0);
        $ts_b = $b['posted_on_unix_ts'] ?? (strtotime($b['posted_on'] ?? '') ?: 0);
        return $ts_b - $ts_a; // Descending order
    });


    foreach ($jobsToday as $job) {
        $title = $job['title'] ?? 'N/A';
        $company = $job['company'] ?? 'N/A'; // Add company for context

        // Assume 'vacant_positions' field exists in your JSON, default to 1
        $vacantPositions = $job['vacant_positions'] ?? 1;

        $message .= "• " . $title;
        // Add count only if greater than 1
        if ($vacantPositions > 1) {
            $message .= " (" . $vacantPositions . ")";
        }
        $message .= " at " . $company . "\n"; // Include company name
    }
}

// Add the site URL at the end
$message .= "\nExplore all jobs on our website!\n";
$message .= $siteUrl . "\n";


// --- Output the formatted message ---
// Note: This script *only* outputs the message text.
// You need to manually copy this output and paste it into your WhatsApp Channel.
echo $message;

?>